---
title: "1.5.Linear.Models.Complexity.Metrics"
author: "Kevin Bruce"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: yes
    theme: united
---
 
#Load Packages/Data
```{r Load the packages and load mpq data, include=FALSE}
rm(list = ls()) #This clears the environment
dev.off()

library(dplyr)
library(ggplot2)
library(stats)
library(Rmisc)
library(here)
library(ggpmisc)
library(knitr)
library(magick)
library(gridExtra)
library(car)
library(tidyr)
library(readxl)
library(vegan)
library(tidyverse)
library(ade4)
library(MASS)
library(ellipse)
library(FactoMineR)
library(arm)
library(ape)
library(ggrepel)
library(FactoMineR)
library(ggpubr)
library(corrplot)
library(Matrix)
library(lme4)
library(TMB)
library(glmmTMB)
library(MuMIn)
library(vegan)
library(nlme)
library(randomForest)


#----------------------------------------------------------------------------------------------------------------------------------------------------------
#Set the Working Directory
setwd("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data")

### 1. Habitat Volume Data
cc <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_CloudCompare_Data_Clean_11Dec2020.csv",header=TRUE, row.names=1)

str(cc)
unique(cc$timepoint)


#Change name of volume.change to hab.vol
colnames(cc)[which(names(cc)=="volume.change")] <- "hab.vol"

#Change site to a factor (for the random effect modelling)
cc$site <- as.factor(cc$site)

unique(cc$hum_dist)
cc$hum_dist <- factor(cc$hum_dist, levels = c("Very High", "Medium", "Very Low"))
cc$region.4 <- factor(cc$region.4, levels = c("Leeward", "Bay of Wrecks", "Vaskess Bay"))

cc$timepoint<- as.factor(cc$timepoint)
cc$timepoint <- factor(cc$timepoint, levels = c("2015-2017", "2017-2019", "2015-2019"))
    
#Data histrogram
hist(cc$hab.vol)
qqnorm(cc$hab.vol)
qqline(cc$hab.vol)


#----------------------------------------------------------------------------------------------------------------------------------------------------------
### 2. Fractal Dimension Data
frac <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Fractal_Dimension_Data_Clean.csv", row.names = 1)

#Rename fractal dimension collumn to frac
colnames(frac)[which(names(frac)=="fractal.dimension")] <- "frac"

#Change site to a factor (for the random effect modeling)
frac$site <- as.factor(frac$site)


#Test for normality.....
hist(frac$frac)

    
#----------------------------------------------------------------------------------------------------------------------------------------------------------
# 3. Complexity Data
mpq <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Complexity_ALL_Data_Clean_FINAL.11Dec2020.csv", header=TRUE, row.names = 1)

mpq <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/Complexity.Data.Final.21Dec2020.csv", header=TRUE, row.names = 1)


#Correct levels of hum_dist
levels(mpq$hum_dist)
mpq$hum_dist <- factor(mpq$hum_dist, levels = c("Very Low", "Medium", "Very High"))
levels(mpq$hum_dist)

#Change site to a factor (for the random effect modelling)
mpq$site <- as.factor(mpq$site)

#Create subsets for each DEM
mpq.1 <- subset (mpq, DEM == 1) 
mpq.4 <- subset (mpq, DEM == 4) 
mpq.8 <- subset (mpq, DEM == 8) 


#Range Data for 1cm DEM
mpq.1.range <- mpq.1[-54,] #Drop 2016b Site 30 MPQ1 for DEM1cm as there are cells without any coverage in the plot. 

#Transformed Data
mpq.1.range$plan.range.t2 <- log10(mpq.1.range$plan.range) #Log Transformed
mpq.1.range$plan.range.t <- sqrt(mpq.1.range$plan.range) #Square Root Transformed


#--------------------------------------------------------------------------------------------------------------------------------------------
##### Digitization Data for Random Forest Regressions and later modelling
#Import Data
mpq.dig.1 <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Complex+Digitization_1cm_Data_11Dec20.csv", row.names = 1) #DEM 1cm
mpq.dig.4 <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Complex+Digitization_4cm_Data_11Dec20.csv", row.names = 1) #DEM 4cm
mpq.dig.8 <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Complex+Digitization_8cm_Data_11Dec20.csv", row.names = 1) #DEM 8cm

```

```{r Exploratory plots rug, eval=FALSE, include=FALSE}
mpq #Dataset
mpq.num <- mpq[,16:21] #numeric datagrame only

#Check the distribution of the complexity metric
hist(mpq$vrm)   #Pretty normal looking honestly....
mpq$vlog<- log(mpq$vrm) *(-1)
hist(mpq$vlog)   #Pretty normal looking honestly....

levels(mpq$year)
str(mpq$year)

#Look for outliers via Cleveland dotplot
dotchart(mpq$vrm, ylab = "Order of operations", xlab = "Concenration", main= "VRM Cleveland Dotplot")
dotchart(mpq$vrm, groups = factor(mpq$year), ylab = "Year", xlab = "Concentration", main ="VRM Cleveland Dotplot", pch=mpq$year)

#pairplot
pairs(mpq.num) #AREA_3d and rug are collinear it appears, with curvature values very similar

#Boxplots 
boxplot(vrm ~ factor(year), varwidth = TRUE, data = mpq)
plot(vrm~site, data = mpq)


```

# Overview of each variable
Site = Random effect to account for difference between ppqs at a single site (not found in any of top models)

Region = Ultimately, this is to check and see whether different levels of wave energy/etc. found in select regions plays a role on the complexity around the atoll

Hum_Dist = Categorical human disturbance variable, "Very Low" is part of the baseline

sqrt.hdist.cont= Continuous human disturbance gradient value square root transformed

# Model Selection

AICc will be used anytime n/k < 40. (n = sample size, k = # of parameters in model).
- Therefore, for models with all DEM's involved, AIC will be used
- If we choose to breakdown models into indvidual DEM scales (n = 127), anything with more than K=3 will require AICc (Burnham & Anderson, 2004 --> Page 270 of document)

# Data Selection

- All data will be modelled for 1cm DEM intially, with further breakdowns done for additional DEM's at a later date

# Computing mean and standard dev
```{r compute mean, include=FALSE}
## Calculate mean, standard deviation, and standard error for each structural complexity metric

# Surface Complexity
complx <- aggregate(rug ~ year, mpq.1, mean)
complx.sd <- aggregate(rug ~ year, mpq.1, function(x) sd(x))
complx.se <- aggregate(rug ~ year, mpq.1, function(x) sd(x)/sqrt(length(x)))
complx$SD <- complx.sd$rug #Add SD to mean value dataframe
complx$SE <- complx.se$rug #Add SE to mean value dataframe
complx

# Terrain ruggedness
tr <- aggregate(vrm ~ year, mpq.1, mean)
tr.sd <- aggregate(vrm ~ year, mpq.1, function(x) sd(x))
tr.se <- aggregate(vrm ~ year, mpq.1, function(x) sd(x)/sqrt(length(x)))
tr$SD <- tr.sd$vrm #Add SD to mean value dataframe
tr$SE <- tr.se$vrm #Add SE to mean value dataframe
tr

# Fractal Dimension
fd <- aggregate(frac ~ year, frac, mean)
fd.sd <- aggregate(frac ~ year, frac, function(x) sd(x))
fd.se <- aggregate(frac ~ year, frac, function(x) sd(x)/sqrt(length(x)))
fd$SD <- fd.sd$frac #Add SD to mean value dataframe
fd$SE <- fd.se$frac #Add SE to mean value dataframe
fd

# Profile Curvature Range
pro <- aggregate(pro.range ~ year, mpq.1, mean)
pro.sd <- aggregate(pro.range ~ year, mpq.1, function(x) sd(x))
pro.se <- aggregate(pro.range ~ year, mpq.1, function(x) sd(x)/sqrt(length(x)))
pro$SD <- pro.sd$pro.range #Add SD to mean value dataframe
pro$SE <- pro.se$pro.range #Add SE to mean value df
pro

#Planform Curvature Range
plan <- aggregate(plan.range ~ year, mpq.1, mean)
plan.sd <- aggregate(plan.range ~ year, mpq.1, function(x) sd(x))
plan.se <- aggregate(plan.range ~ year, mpq.1, function(x) sd(x)/sqrt(length(x)))
plan$SD <- plan.sd$plan.range #Add SD to mean value dataframe
plan$SE <- plan.se$plan.range #Add SE to mean value df
plan


# Habitat Volume
vol <- aggregate(hab.vol ~ timepoint, cc, mean)
vol.sd <- aggregate(hab.vol ~ timepoint, cc, function(x) sd(x))
vol.se <- aggregate(hab.vol ~ timepoint, cc, function(x) sd(x)/sqrt(length(x)))
vol$SD <- vol.sd$hab.vol #Add SD to mean value dataframe
vol$SE <- vol.se$hab.vol #Add SE to mean value df
vol

```

## 1. VRM {.tabset}
### A. Investigating categorical Hum_Dist vs continuous square root transformed Hum_dist
```{r vrm fixed effect models}
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
vrm1 <- lm(vrm ~ year + hum_dist, data = mpq.1) #Hum_Dist = Categorical
vrm2 <- lm(vrm ~ year + sqrt.hdist.cont, data = mpq.1)
vrm3 <- lm(vrm ~ year * hum_dist, data = mpq.1)
vrm4 <- lm(vrm~year*sqrt.hdist.cont, data = mpq.1)

AIC(vrm1, vrm2,vrm3,vrm4) #Top model = vrm4
summary(vrm1)
summary(vrm2)
summary(vrm3)
summary(vrm4)

# nrow(mpq.1) 127 = Any model with 3 variables or less = can use AIC
```

### B. Investigate region and human disturbance (cont and categorical)

```{r vrm region with interactions with hdist}
#Categorical human disturbance against region, then categorical interaction with year
#Models without interaction of disturbance added with different regions
vrm5 <- lm(vrm ~ year + hum_dist + island.side, data = mpq.1) 
vrm6 <- lm(vrm~ year + hum_dist + region.3, data = mpq.1)
vrm7 <- lm(vrm ~ year*hum_dist + island.side, data = mpq.1)
vrm8 <- lm(vrm~year*hum_dist + region.3, data = mpq.1)

AIC(vrm5, vrm6, vrm7, vrm8) #VRM5/6 fit better (with interaction)

summary(vrm7)
summary(vrm8)

#Continuous human disturbance against region, then Continuous disturbance interaction with year
vrm9 <- lm(vrm ~ year + sqrt.hdist.cont + island.side, data = mpq.1)
vrm10  <- lm(vrm ~ year + sqrt.hdist.cont + region.3, data = mpq.1)
vrm11 <- lm(vrm ~ year*sqrt.hdist.cont + island.side, data = mpq.1)
vrm12 <- lm(vrm ~ year*sqrt.hdist.cont + region.3, data = mpq.1)

AIC(vrm9, vrm10, vrm11, vrm12) #VRM11 best, followed closely by vrm 12

summary(vrm10)
summary(vrm9)
summary(vrm11)
summary(vrm12)


#AIC's for all
AIC(vrm5, vrm6, vrm7, vrm8, vrm9, vrm10,vrm11, vrm12)  #vrm11/vrm12 fit best

```

### C. With Random Effect (1|site)
- Adding to previous model iterations with both human disturbances, some with interactions between year&hum_dist, and various regions of "best fit" (island.side and region4 only)

```{r vrm simple random effects}
#Continuous disturbance- no interaction
vrm13 <- lmer(vrm~year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1)
vrm14 <- lmer(vrm~year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1)
vrm15 <- lmer(vrm~year + sqrt.hdist.cont + (1|site), data = mpq.1)
vrm16 <- lmer(vrm~year + hum_dist + (1|site), data = mpq.1)

AIC(vrm13, vrm14, vrm15, vrm16) #VRM15 best fit, but vrm13& are close  (1 - 2 AIC)

#Results of models
summary(vrm13)
summary(vrm14)
summary(vrm15)
summary(vrm16)
anova(vrm13, vrm14, vrm15, vrm16) #Says vrm13 is best followed by vrm14

#With interactions
vrm17 <- lmer(vrm~year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1)
vrm18 <- lmer(vrm~year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1)
vrm19 <- lmer(vrm~year * sqrt.hdist.cont + (1|site), data = mpq.1)
vrm20 <- lmer(vrm~year * hum_dist + (1|site), data = mpq.1)

AIC(vrm17, vrm18, vrm19, vrm20) #vrm19 & 17 are best fit

#Results of best fitting models
summary(vrm17)
summary(vrm18)
summary(vrm19)
summary(vrm20)

anova(vrm17, vrm18, vrm19, vrm20)


#AIC of all models
AIC(vrm13, vrm14, vrm15,vrm16, vrm17, vrm18, vrm19, vrm20) #VRM15/16 best fit

#Choosing top model
AIC(vrm1, vrm2, vrm3, vrm4, vrm5, vrm6,vrm7, vrm8, vrm9, vrm10,vrm11, vrm12, vrm13, vrm14, vrm15, vrm16,vrm17, vrm18, vrm19, vrm20 ) #Best fit models are: vrm11<vrm12<vrm9<vrm10


#End Result: vrm11 is best fit
x <- AIC(vrm11, vrm12, vrm9, vrm10)
AICc(vrm11, vrm12, vrm9, vrm10) #Same as AIC

summary(vrm11) # vrm ~ year * sqrt.hdist.cont + island.side, data = mpq.1
summary(vrm12) #vrm ~ year * sqrt.hdist.cont + region.3, data = mpq.1)

#These two are > 4AIC different than top model
summary(vrm9) #vrm ~ year + sqrt.hdist.cont + island.side, data = mpq.1
summary(vrm10) #vrm ~ year + sqrt.hdist.cont + region.3, data = mpq.1

#anova(vrm10, vrm9,vrm12, vrm11)

#Models were refit with Maximum Likelihood (ML) instead of REML


```

### D. Final findings:

- Sqrt transformed continuous disturbance improved models vs categorical disturbance

- Interactions between year and disturbance(continuous) aided in the best fitting models selected

- Site random effect didn't improve model fit


Final Working Models (all within:

Top Model: **VRM ~ year * sqrt.hdist.cont + island.side** 

Runner Up: **VRM ~ year * sqrt.hdist.cont + region3**



These 2 are > 4AIC from top model, but within 4AIC of runner up

**VRM ~ year + sqrt.hdist.cont + island.side** 

**VRM ~ year + sqrt.hdist.cont + region3**



## 2. Surface Complexity {.tabset}
### A. Investigating categorical Hum_Dist vs continuous square root transformed Hum_dist
```{r rug fixed effect models}
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
rug1 <- lm(rug ~ year + hum_dist, data = mpq.1) #Hum_Dist = Categorical
rug2 <- lm(rug ~ year + sqrt.hdist.cont, data = mpq.1)
rug3 <- lm(rug ~ year * hum_dist, data = mpq.1)
rug4 <- lm(rug~year*sqrt.hdist.cont, data = mpq.1)

AIC(rug1, rug2,rug3,rug4) #Top model = rug2 --> rug4 >rug1
summary(rug1)
summary(rug2)
summary(rug3)
summary(rug4)

```

### B. Investigate region and human disturbance (cont and categorical)
```{r rug region with interactions with hdist}
#Categorical human disturbance against region, then categorical interaction with year
#Models without interaction of disturbance added with different regions
rug5 <- lm(rug ~ year + hum_dist + island.side, data = mpq.1) 
rug6 <- lm(rug~ year + hum_dist + region.3, data = mpq.1)
rug7 <- lm(rug ~ year*hum_dist + island.side, data = mpq.1)
rug8 <- lm(rug~year*hum_dist + region.3, data = mpq.1)

AIC(rug5, rug6, rug7, rug8) #Rug5/6 best fit

summary(rug5)
summary(rug6)
summary(rug7)
summary(rug8)

#Continuous human disturbance against region, then Continuous disturbance interaction with year
rug9 <- lm(rug ~ year + sqrt.hdist.cont + island.side, data = mpq.1)
rug10  <- lm(rug ~ year + sqrt.hdist.cont + region.3, data = mpq.1)
rug11 <- lm(rug ~ year*sqrt.hdist.cont + island.side, data = mpq.1)
rug12 <- lm(rug ~ year*sqrt.hdist.cont + region.3, data = mpq.1)

AIC(rug9, rug10, rug11, rug12) #rug9>rug10>rug11>rug12 

summary(rug9)
summary(rug10)
summary(rug11)
summary(rug12)


#AIC's for all
AIC(rug5, rug6, rug7, rug8, rug9, rug10,rug11, rug12)  #Rug9, 10 are best fits

```

### C. With Random Effect (1|site)
- Adding to previous model iterations with both human disturbances, some with interactions between year&hum_dist, and various regions of "best fit" (island.side and region4 only)

```{r rug simple random effects}
#Continuous disturbance
#no interaction
rug13 <- lmer(rug~year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1)
rug14 <- lmer(rug~year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1)
rug15 <- lmer(rug~year + sqrt.hdist.cont + (1|site), data = mpq.1)
rug16 <- lmer(rug~year + hum_dist + (1|site), data = mpq.1)

AIC(rug13, rug14, rug15, rug16) #rug16 best fit

summary(rug13)
summary(rug14)
summary(rug15)
summary(rug16)

anova(rug13, rug14, rug15, rug16) #this says rug13 fits best (13<14<15<16)

#With interactions
rug17 <- lmer(rug~year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1)
rug18 <- lmer(rug~year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1)
rug19 <- lmer(rug~year * sqrt.hdist.cont + (1|site), data = mpq.1)
rug20 <- lmer(rug~year * hum_dist + (1|site), data = mpq.1)

AIC(rug17, rug18, rug19, rug20) #rug20 best fit

summary(rug17)
summary(rug18)
summary(rug19)
summary(rug20)

#Results of best fitting models
anova(rug17,rug18,rug19, rug20) #States rug17 as best fit (17<19<18<<20)

#Combine all together
AIC(rug13, rug14, rug15, rug16,rug17, rug18, rug19, rug20) #rug16 best fit

#Final Model selection:
AIC(rug1, rug2, rug3, rug4, rug5, rug6, rug7, rug8, rug9, rug10,rug11, rug12, rug13, rug14, rug15, rug16,rug17, rug18, rug19, rug20) #Best fitting (rug9/10/11)

#End Result: rug9/10 models are best fit 
summary(rug9) #rug ~ year + sqrt.hdist.cont + island.side, data = mpq.1
summary(rug10) #rug ~ year + sqrt.hdist.cont + region.3, data = mpq.1 
summary(rug11) #rug ~ year * sqrt.hdist.cont + island.side, data = mpq.1

AIC(rug9, rug10, rug11)
AICc(rug9,rug10,rug11) #Same as AIC

anova(rug9, rug10)
```

### D. Final findings:

- Sqrt transformed continuous disturbance fits better than categorical (for now) -->varies on how much "better" the fit is based on the model

- Interactions between either year and disturbance(continuous) or year and region all come out as worse fits than non-interaction, so probably best to drop

- Random effect has SUPER low estimates in best fit model; maybe not really that required? --> AIC between models that have same components except site RE show that including site makes the AIC a larger negative # (therefore,  --> aka better fit)


Final Working Models:

**rug ~ year + sqrt.hdist.cont + island.side** 

**rug ~ year + sqrt.hdist.cont + region3**

**rug ~ year*sqrt.hdist.cont + region3**


## 3. Fractal Dimension {.tabset}

### Fractal Dimension Dataset is normal
```{r frac appears normal, echo=FALSE}
#Data appears normal
ggplot(frac, aes(x=frac)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="Looks Normally Distributed",x="Fractal Dimension", y = "Density") + geom_vline(aes(xintercept = mean(frac)),col='red',size=0.3) + geom_vline(aes(xintercept = median(frac)),col='blue',size=0.3)


```

### A. Investigating categorical Hum_Dist vs continuous square root transformed Hum_dist
```{r frac fixed effect models}
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
frac1 <- lm(frac ~ year + hum_dist, data = frac) #Hum_Dist = Categorical
frac2 <- lm(frac ~ year + sqrt.hdist.cont, data = frac)
frac3 <- lm(frac ~ year * hum_dist, data = frac)
frac4 <- lm(frac~year*sqrt.hdist.cont, data = frac)

AIC(frac1, frac2,frac3,frac4) #Top model = frac4
summary(frac1)
summary(frac2)
summary(frac3)
summary(frac4)

```

### B. Investigate region and human disturbance (cont and categorical)
```{r frac region with interactions with hdist}
#Categorical human disturbance against region, then categorical interaction with year
#Models without interaction of disturbance added with different regions
frac5 <- lm(frac ~ year + hum_dist + island.side, data = frac) 
frac6 <- lm(frac~ year + hum_dist + region.3, data = frac)
frac7 <- lm(frac ~ year*hum_dist + island.side, data = frac)
frac8 <- lm(frac~year*hum_dist + region.3, data = frac)

AIC(frac5, frac6, frac7, frac8) #frac7,8 best

summary(frac5)
summary(frac6)
summary(frac7)
summary(frac8)

#Dom recommends not to include categorical human disturbance as it messes with the modelling process --> Stick to continuous variable
```

**The model output for the "best fitting" model using the categorical human disturbance value comes out all wierd. In talking with Dom about it and after showing her the equivalent model with the linear continuous human disturbance, she recommends not using the categorical variable as it makes "more modelling sense" to use the continuous with my data**



```{r frac continuous human dist}
#Continuous human disturbance against region, then Continuous disturbance interaction with year
frac9 <- lm(frac ~ year + sqrt.hdist.cont + island.side, data = frac)
frac10  <- lm(frac ~ year + sqrt.hdist.cont + region.3, data = frac)
frac11 <- lm(frac ~ year*sqrt.hdist.cont + island.side, data = frac)
frac12 <- lm(frac ~ year*sqrt.hdist.cont + region.3, data = frac)

AIC(frac9, frac10, frac11, frac12) #Frac12<Frac11 best 2 (close ~1AIC between them)

summary(frac9)
summary(frac10)
summary(frac11)
summary(frac12)


#AIC's for all
AIC(frac5, frac6, frac7, frac8, frac9, frac10,frac11, frac12)  #frac7, frac8, frac11, frac12 are best fits

#AICc needs to be used if I add 1 more parameter (currently n/k = 42)
nrow(frac) #127 total rows

```

### C. With Random Effect (1|site)
- Adding to previous model iterations with both human disturbances, some with interactions between year&hum_dist, and various regions of "best fit" (island.side and region4 only)

```{r frac simple random effects}
#Continuous disturbance
#no interaction
frac13 <- lmer(frac~year + sqrt.hdist.cont + island.side + (1|site), data = frac)
frac14 <- lmer(frac~year + sqrt.hdist.cont + region.3 + (1|site), data = frac)
frac15 <- lmer(frac~year + sqrt.hdist.cont + (1|site), data = frac)
frac16 <- lmer(frac~year + hum_dist + (1|site), data = frac)

#Using AICc since we dip into (n/k<40) region, compare all using AICc and find that model frac14 best fit
AICc(frac13, frac14, frac15, frac16) #frac14

#Results of best fitting models
summary(frac13)
summary(frac14)
summary(frac15)
summary(frac16)

anova(frac13, frac14, frac15, frac16) #this says frac14 firts best

#With interactions
frac17 <- lmer(frac~year *sqrt.hdist.cont + island.side + (1|site), data = frac)
frac18 <- lmer(frac~year * sqrt.hdist.cont + region.3 + (1|site), data = frac)
frac19 <- lmer(frac~year * sqrt.hdist.cont + (1|site), data = frac)
frac20 <- lmer(frac~year * hum_dist + (1|site), data = frac)

nrow(frac) #127 --> anything more than 3 variables = use AICc

AIC(frac17, frac18, frac19, frac20) #frac19 best fit 
anova(frac17,frac18,frac19, frac20) #States frac17 as best fit 

summary(frac17)
summary(frac18)
summary(frac19)
summary(frac20)

#Results of best fitting models
AIC(frac13, frac14, frac15, frac16,frac17, frac18, frac19, frac20) #frac15 or frac13 best fit


#Results
# Interaction between year and human disturbance (which Jen did) doesn't make the models fit better
# Best fitting model has no region values within it (with continuous human disturbance model slightly better than categorical one)


AICc(frac1, frac2, frac3, frac4, frac9, frac10,frac11, frac12, frac13, frac14, frac15, frac16,frac17, frac18, frac19, frac20) #Frac11,12 are best fits (with frac10 and 9 following)

#End Result: frac11/12 models are best fit 

AIC(frac12, frac11, frac10, frac9)
AICc(frac12, frac11, frac10, frac9)

summary(frac12) #frac ~ year * sqrt.hdist.cont + region.3, data = frac)
summary(frac11) #frac ~ year * sqrt.hdist.cont + island.side, data = frac

#These two are just at or more than 4AIC different than top 2 models
summary(frac10) #frac ~ year + sqrt.hdist.cont + region.3, data = frac
summary(frac9) #frac ~ year + sqrt.hdist.cont + region.3, data = frac




#anova(frac9, frac10, frac11, frac12)


```

### D. Final findings:

- Sqrt transformed continuous disturbance fits better than categorical (for now) -->varies on how much "better" the fit is based on the model

- Best fit models turn out to be the ones with interactions between year and disturbance

- All best fit models didn't include random effect

Final Working Model(s):

**frac ~ year * sqrt.hdist.cont + region.3** 

**frac ~ year * sqrt.hdist.cont + island.side** 

**frac ~ year + sqrt.hdist.cont + region.3**


# 4. Habitat Volume {.tabset}
### Data appears to not be normally distributed
```{r non normal data distribution, echo=FALSE}
# cc$sq.hab.vol.t <- cc$hab.vol+3
# cc$sq.hab.vol.t <- asin(cc$hab.vol) #Arcsin perhaps?

# hist(cc$sq.hab.vol)
# qqnorm(cc$hab.vol)
# qqline(cc$hab.vol)


#Data is not normal
ggplot(cc, aes(x=hab.vol)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Volumetric Change (m^3)", y = "Density") + geom_vline(aes(xintercept = mean(hab.vol)),col='red',size=0.3) + geom_vline(aes(xintercept = median(hab.vol)),col='blue',size=0.3)

```

### A. Investigating categorical Hum_Dist vs continuous square root transformed Hum_dist
```{r hab volfixed effect models}
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
hab.vol1 <- lm(hab.vol ~ timepoint + hum_dist, data = cc) #Hum_Dist = Categorical
hab.vol2 <- lm(hab.vol ~ timepoint + sqrt.hdist.cont, data = cc)
hab.vol3 <- lm(hab.vol ~ timepoint * hum_dist, data = cc)
hab.vol4 <- lm(hab.vol~timepoint*sqrt.hdist.cont, data = cc)

AIC(hab.vol1, hab.vol2,hab.vol3,hab.vol4) #Top model = hab.vol1, hab.vol3
summary(hab.vol1)
summary(hab.vol2)
summary(hab.vol3)
summary(hab.vol4)

#Best fit: Hab.vol1, hab.vol3

```

### B. Investigate region and human disturbance (cont and categorical)
```{r hab volregion with interactions with hdist}
#Categorical human disturbance against region, then categorical interaction with year
#Models without interaction of disturbance added with different regions
hab.vol5 <- lm(hab.vol ~ timepoint + hum_dist + island.side, data = cc) 
hab.vol6 <- lm(hab.vol~ timepoint + hum_dist +region.3, data = cc)
hab.vol7 <- lm(hab.vol ~ timepoint*hum_dist + island.side, data = cc)
hab.vol8 <- lm(hab.vol~timepoint*hum_dist + region.3, data = cc)

summary(hab.vol5)
summary(hab.vol6)
summary(hab.vol7)
summary(hab.vol8)

AIC(hab.vol5, hab.vol6, hab.vol7, hab.vol8) #AIC's the same based on if interaction is present or not (interaction makes it worse)

#Again, Dom recommends not to include categorical human disturbance as it messes with the modelling process --> Stick to continuous variable

```

```{r habvol continuous human dist}
#Continuous human disturbance against region, then Continuous disturbance interaction with timepoint
hab.vol9 <- lm(hab.vol ~ timepoint + sqrt.hdist.cont + island.side, data = cc)
hab.vol10  <- lm(hab.vol ~ timepoint + sqrt.hdist.cont + region.3, data = cc)
hab.vol11 <- lm(hab.vol ~ timepoint*sqrt.hdist.cont + island.side, data = cc)
hab.vol12 <- lm(hab.vol ~ timepoint*sqrt.hdist.cont + region.3, data = cc)

AIC(hab.vol9, hab.vol10, hab.vol11, hab.vol12) #hab.vol10 best fit, followed by hab.vol12, hab.vol9 (each 2 AIC apart from one another)

summary(hab.vol9)
summary(hab.vol10)
summary(hab.vol11)
summary(hab.vol12)   #Best fit: Hab.vol10


```

### C. With Random Effect (1|site)
- Adding to previous model iterations with both human disturbances, some with interactions between timepoint&hum_dist, and various regions of "best fit" (island.side and region4 only)

```{r hab vol random effects}
#Continuous disturbance
#no interaction
hab.vol13 <- lmer(hab.vol~timepoint + sqrt.hdist.cont + island.side + (1|site), data = cc)
hab.vol14 <- lmer(hab.vol~timepoint + sqrt.hdist.cont + region.3 + (1|site), data = cc)
hab.vol15 <- lmer(hab.vol~timepoint + sqrt.hdist.cont + (1|site), data = cc)
hab.vol16 <- lmer(hab.vol~timepoint + hum_dist + (1|site), data = cc)

AIC(hab.vol13, hab.vol14, hab.vol15, hab.vol16) #hab.vol16<14 <13<15 best fit 

#Results of best fitting models
summary(hab.vol13)
summary(hab.vol14)
summary(hab.vol15)
summary(hab.vol16)

anova(hab.vol13, hab.vol14, hab.vol15, hab.vol16) #this says hab.vol16 fits best (14<13<15)

#With interactions
hab.vol17 <- lmer(hab.vol~timepoint *sqrt.hdist.cont + island.side + (1|site), data = cc)
hab.vol18 <- lmer(hab.vol~timepoint * sqrt.hdist.cont + region.3 + (1|site), data = cc)
hab.vol19 <- lmer(hab.vol~timepoint * sqrt.hdist.cont + (1|site), data = cc)
hab.vol20 <- lmer(hab.vol~timepoint * hum_dist + (1|site), data = cc)

AIC(hab.vol17, hab.vol18, hab.vol19, hab.vol20) #hab.vol20 best fit, but it and hab.vol18 are providing errors

#Results of best fitting models
anova(hab.vol17,hab.vol18,hab.vol19, hab.vol20) #States hab.vol20 as best fit (18<17<19)

#Combine all together
AIC(hab.vol13, hab.vol14, hab.vol15, hab.vol16, hab.vol17, hab.vol18, hab.vol19, hab.vol20) #hab.vol16 best fit

#Choosing final model
#Test fits with AICc since the sample size is small
AICc(hab.vol1, hab.vol2, hab.vol3, hab.vol4, hab.vol9, hab.vol10,hab.vol11, hab.vol12, hab.vol13, hab.vol14, hab.vol15,hab.vol17, hab.vol18, hab.vol19) #Hab.vol1 and hab.vol10 are best models

summary(hab.vol1)
summary(hab.vol10)
summary(hab.vol3)
summary(hab.vol12)


```

### D. Final findings:
- Sqrt transformed continuous disturbance fits better than categorical, particularly as the categorical variable interferes with the modeling process when incorporating region as a categorical variable too (Dom recommends stating we used continuous human disturbance with modeling, and categorical variable with plotting only)

- Best fit models do not have any interactions or random effects

- All models compared using AICc

Final Working Model(s):

- **Habitat Volumetric Change ~ timepoint + sqrt.hdist.cont + region.3** 

OR 

- **Habitat Volumetric Change ~ timepoint + hum_dist** 

```{r residiual and fitted plot of final models}

#Hab.vol1
plot(fitted(hab.vol1), resid(hab.vol1))

#Hab.vol10
plot(fitted(hab.vol10), resid(hab.vol10))
```


# 5. Profile Curvature {.tabset}

## Distribution + Transformations
```{r raw pro curv distribution, echo=FALSE}

# hist(mpq$pro.range)


ggplot(mpq.1, aes(x=pro.range)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Pro.Curv.Range", y = "Density") + geom_vline(aes(xintercept = mean(pro.range)),col='red',size=0.3) + geom_vline(aes(xintercept = median(pro.range)),col='blue',size=0.3) + ggtitle("Raw Data")

#REMOVE ROW 54
mpq.1.range <- mpq.1[-54,] #Drop 2016b Site 30 MPQ1 for DEM1cm as there are cells without any coverage in the plot. 

#After dropping the outlier, it looks better!
ggplot(mpq.1.range, aes(x=pro.range)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Pro.Curv.Range", y = "Density") + geom_vline(aes(xintercept = mean(pro.range)),col='red',size=0.3) + geom_vline(aes(xintercept = median(pro.range)),col='blue',size=0.3) + ggtitle("Raw Data with outlier removed")


# lmv1 <- lm(pro.range ~ year, data = mpq)
# plot(lmv1)





mpq.1.range$pro.range.t <- sqrt(mpq.1.range$pro.range)
ggplot(mpq.1.range, aes(x=pro.range.t)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Pro.Curv.Range. SQRT", y = "Density") + geom_vline(aes(xintercept = mean(pro.range.t)),col='red',size=0.3) + geom_vline(aes(xintercept = median(pro.range.t)),col='blue',size=0.3) + ggtitle("SquareRoot Transformed")
# lmv1.1 <- lm(pro.range.t ~ year, data = mpq)
# plot(lmv1.1)


#MUCH BETTER
mpq.1.range$pro.range.t2 <- log10(mpq.1.range$pro.range)
ggplot(mpq.1.range, aes(x=pro.range.t2)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Pro.Curv.Range LOG", y = "Density") + geom_vline(aes(xintercept = mean(pro.range.t2)),col='red',size=0.3) + geom_vline(aes(xintercept = median(pro.range.t2)),col='blue',size=0.3)+ ggtitle("Log10 Transformed")
# lmv2 <- lm(pro.range.t ~ year, data = mpq)
# plot(lmv2)



#BAD
mpq.1.range$pro.range.t3 <- 1/(mpq.1.range$pro.range)
ggplot(mpq.1.range, aes(x=pro.range.t3)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Pro.Curv.Range INVERSE", y = "Density") + geom_vline(aes(xintercept = mean(pro.range.t3)),col='red',size=0.3) + geom_vline(aes(xintercept = median(pro.range.t3)),col='blue',size=0.3)+ ggtitle("Inverse Transformed")
# lmv3 <- lm(pro.range.t3 ~ year, data = mpq)
# plot(lmv3)



```

## Gamma Distribution Models

**All models with the random effect fail to converge, so its difficult to compare AIC's of all models to determine top model**

```{r pro curv gamma modelling}
#nrow(mpq.1)# 127 = Any model with 3 variables or less = can use AIC

str(mpq.1.range)
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
pr1 <- glm(pro.range ~ year + hum_dist, data = mpq.1.range, family= Gamma(link=log))
pr2 <- glm(pro.range ~ year + sqrt.hdist.cont, data = mpq.1.range, family= Gamma(link=log))
pr3 <- glm(pro.range ~ year * hum_dist, data = mpq.1.range, family= Gamma(link=log))
pr4 <- glm(pro.range ~ year*sqrt.hdist.cont, data = mpq.1.range, family= Gamma(link=log))

AIC(pr1, pr2,pr3,pr4) #Top model = pr2/pr1
summary(pr1)
summary(pr2)
summary(pr3)
summary(pr4)


#Categorical human disturbance against region, then categorical interaction with year
pr5 <- glm(pro.range ~ year + hum_dist + island.side, data = mpq.1.range, family= Gamma(link=log))
pr6 <- glm(pro.range ~ year + hum_dist + region.3, data = mpq.1.range, family= Gamma(link=log))
pr7 <- glm(pro.range ~ year*hum_dist + island.side, data = mpq.1.range, family= Gamma(link=log))
pr8 <- glm(pro.range ~ year*hum_dist + region.3, data = mpq.1.range, family= Gamma(link=log))

AIC(pr5, pr6, pr7, pr8) #pr5/6 fit better (without interaction)


#Continuous human disturbance against region, then Continuous disturbance interaction with year
pr9 <- glm(pro.range ~ year + sqrt.hdist.cont + island.side, data = mpq.1.range, family= Gamma(link=log))
pr10 <- glm(pro.range ~ year + sqrt.hdist.cont + region.3, data = mpq.1.range, family= Gamma(link=log))
pr11 <- glm(pro.range ~ year*sqrt.hdist.cont + island.side, data = mpq.1.range, family= Gamma(link=log))
pr12 <- glm(pro.range ~ year*sqrt.hdist.cont + region.3, data = mpq.1.range, family= Gamma(link=log))

AIC(pr9, pr10, pr11, pr12) #pr9>pr10>pr11>pr12

#AIC's for all thus far....
AIC(pr1, pr2,pr3,pr4, pr5, pr6, pr7, pr8,pr9, pr10, pr11, pr12)  #pr9 > pr10 > pr2 >pr1 ...




#Continuous disturbance- no interaction (13,14,15,16 models do not converge!)
pr13 <- glmer(pro.range ~ year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range, family= Gamma(link=log))
pr14 <- glmer(pro.range ~ year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range, family= Gamma(link=log))
pr15 <- glmer(pro.range ~ year + sqrt.hdist.cont + (1|site), data = mpq.1.range, family= Gamma(link=log)) 
pr16 <- glmer(pro.range ~ year + hum_dist + (1|site), data = mpq.1.range, family= Gamma(link=log))

AIC(pr13, pr14, pr15, pr16) #pr15< pr13/16 < pr14 all within 2AIC

#Results of models
summary(pr15)
summary(pr16)
summary(vrm16)



#With interactions (17,18,19, 20 do not converge)
pr17 <- glmer(pro.range ~ year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range, family= Gamma(link=log))
pr18 <- glmer(pro.range ~ year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range, family= Gamma(link=log))
pr19 <- glmer(pro.range ~ year * sqrt.hdist.cont + (1|site), data = mpq.1.range, family= Gamma(link=log))
pr20 <- glmer(pro.range ~ year * hum_dist + (1|site), data = mpq.1.range, family= Gamma(link=log))


AIC(pr17, pr18, pr19, pr20) #vrm19 <pr17 <pr20 < pr18

#Results of best fitting models
summary(pr17)
summary(pr18)
summary(pr19)
summary(pr20)


#Choosing top model
AIC(pr1, pr2,pr3,pr4, pr5, pr6, pr7, pr8,pr9, pr10, pr11, pr12, pr13, pr14, pr15, pr16,pr17, pr18, pr19, pr20) #Best fit models are: pr15< pr13 < pr13


nrow(mpq.1.range) #126 rows
 
```

## Log Transformed Models

**All models converge**

**Top models are: pr9 < pr10 <pr2/5/6 < pr1 < pr16**

```{r pro curv log transformed modelling}
#nrow(mpq.1)# 127 = Any model with 3 variables or less = can use AIC
#colnames(mpq.1.range) #Call pro.range.t2

# Models year + disturbance
pr1 <- lm(pro.range.t2 ~ year + hum_dist, data = mpq.1.range)
pr2 <- lm(pro.range.t2 ~ year + sqrt.hdist.cont, data = mpq.1.range)
pr3 <- lm(pro.range.t2 ~ year * hum_dist, data = mpq.1.range)
pr4 <- lm(pro.range.t2 ~ year*sqrt.hdist.cont, data = mpq.1.range)

AIC(pr1, pr2,pr3,pr4) #Top model = pr2/pr1
summary(pr1)
summary(pr2)
summary(pr3)
summary(pr4)


#Categorical human disturbance against region, then categorical interaction with year
pr5 <- lm(pro.range.t2 ~ year + hum_dist + island.side, data = mpq.1.range)
pr6 <- lm(pro.range.t2 ~ year + hum_dist + region.3, data = mpq.1.range)
pr7 <- lm(pro.range.t2 ~ year*hum_dist + island.side, data = mpq.1.range)
pr8 <- lm(pro.range.t2 ~ year*hum_dist + region.3, data = mpq.1.range)

AIC(pr5, pr6, pr7, pr8) #pr5/6 fit better (without interaction)
summary(pr6)

#Continuous human disturbance against region, then Continuous disturbance interaction with year
pr9 <- lm(pro.range.t2 ~ year + sqrt.hdist.cont + island.side, data = mpq.1.range)
pr10 <- lm(pro.range.t2 ~ year + sqrt.hdist.cont + region.3, data = mpq.1.range)
pr11 <- lm(pro.range.t2 ~ year*sqrt.hdist.cont + island.side, data = mpq.1.range)
pr12 <- lm(pro.range.t2 ~ year*sqrt.hdist.cont + region.3, data = mpq.1.range)

AIC(pr9, pr10, pr11, pr12) #pr9>pr10>pr11>pr12

#AIC's for all thus far....
AIC(pr1, pr2,pr3,pr4, pr5, pr6, pr7, pr8,pr9, pr10, pr11, pr12)  #pr9 > pr10 > pr2 >pr1 ...

summary(pr11)


#Continuous disturbance- no interaction (13,14,15 models do not converge!)
pr13 <- lmer(pro.range.t2 ~ year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range)
pr14 <- lmer(pro.range.t2 ~ year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range)
pr15 <- lmer(pro.range.t2 ~ year + sqrt.hdist.cont + (1|site), data = mpq.1.range)
pr16 <- lmer(pro.range.t2 ~ year + hum_dist + (1|site), data = mpq.1.range)

AIC(pr13, pr14, pr15, pr16) #pr16 < pr15 < pr13 < pr14

#Results of models
summary(pr15)
summary(pr16)



#With interactions (17,18,19 do not converge)
pr17 <- lmer(pro.range.t2 ~ year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range)
pr18 <- lmer(pro.range.t2 ~ year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range)
pr19 <- lmer(pro.range.t2 ~ year * sqrt.hdist.cont + (1|site), data = mpq.1.range)
pr20 <- lmer(pro.range.t2 ~ year * hum_dist + (1|site), data = mpq.1.range)


AIC(pr17, pr18, pr19, pr20) #pr20 < pr19 < pr17 <pr18

#Results of best fitting models
summary(pr17)
summary(pr18)
summary(pr19)
summary(pr20)


#Choosing top model
AIC(pr1, pr2,pr3,pr4, pr5, pr6, pr7, pr8,pr9, pr10, pr11, pr12, pr13, pr14, pr15, pr16,pr17, pr18, pr19, pr20) #Best fit models are: pr9 < pr10 <pr2/5/6 < pr1 < pr16

#AICc(pr1, pr2,pr3,pr4, pr5, pr6, pr7, pr8,pr9, pr10, pr11, pr12, pr13, pr14, pr15, pr16,pr17, pr18, pr19, pr20) #Best fit models are: pr9 < pr10 <pr2/5/6 < pr1 < pr16

```



# 6. Planform Curvature {.tabset}

## Distribution + Transformations
```{r raw plan curv distribution, echo=FALSE}

# hist(mpq$plan.range)


ggplot(mpq.1, aes(x=plan.range)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Plan.Curv.Range", y = "Density") + geom_vline(aes(xintercept = mean(plan.range)),col='red',size=0.3) + geom_vline(aes(xintercept = median(plan.range)),col='blue',size=0.3) + ggtitle("Raw Data")

#REMOVE ROW 54
mpq.1.range <- mpq.1[-54,] #Drop 2016b Site 30 MPQ1 for DEM1cm as there are cells without any coverage in the plot. 

#After dropping the outlier, it looks better!
ggplot(mpq.1.range, aes(x=plan.range)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Plan.Curv.Range", y = "Density") + geom_vline(aes(xintercept = mean(plan.range)),col='red',size=0.3) + geom_vline(aes(xintercept = median(plan.range)),col='blue',size=0.3) + ggtitle("Raw Data with outlier removed")


# lmv1 <- lm(plan.range ~ year, data = mpq)
# plot(lmv1)





mpq.1.range$plan.range.t <- sqrt(mpq.1.range$plan.range)
ggplot(mpq.1.range, aes(x=plan.range.t)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Plan.Curv.Range. SQRT", y = "Density") + geom_vline(aes(xintercept = mean(plan.range.t)),col='red',size=0.3) + geom_vline(aes(xintercept = median(plan.range.t)),col='blue',size=0.3) + ggtitle("SquareRoot Transformed")
# lmv1.1 <- lm(plan.range.t ~ year, data = mpq)
# plot(lmv1.1)


#MUCH BETTER
mpq.1.range$plan.range.t2 <- log10(mpq.1.range$plan.range)
ggplot(mpq.1.range, aes(x=plan.range.t2)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Plan.Curv.Range LOG", y = "Density") + geom_vline(aes(xintercept = mean(plan.range.t2)),col='red',size=0.3) + geom_vline(aes(xintercept = median(plan.range.t2)),col='blue',size=0.3)+ ggtitle("Log10 Transformed")
# lmv2 <- lm(plan.range.t2 ~ year, data = mpq)
# plot(lmv2)



#BAD
mpq.1.range$plan.range.t3 <- 1/(mpq.1.range$plan.range)
ggplot(mpq.1.range, aes(x=plan.range.t3)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", bins= 30)+
 geom_density(alpha=.2, fill="#FF6666") + labs(title="red = mean | blue = median",x="Plan.Curv.Range INVERSE", y = "Density") + geom_vline(aes(xintercept = mean(plan.range.t3)),col='red',size=0.3) + geom_vline(aes(xintercept = median(plan.range.t3)),col='blue',size=0.3)+ ggtitle("Inverse Transformed")
# lmv3 <- lm(plan.range.t3 ~ year, data = mpq)
# plot(lmv3)



```


## Gamma Distribution Models

**All models with the random effect fail to converge, so its difficult to compare AIC's of all models to determine top model**

```{r plan curv gamma modelling}
#nrow(mpq.1)# 127 = Any model with 3 variables or less = can use AIC

#str(mpq.1.range)

#Models looking at disturbance gradient and if interaction between year&disturbance fit better
plan1 <- glm(plan.range ~ year + hum_dist, data = mpq.1.range, family= Gamma(link=log))
plan2 <- glm(plan.range ~ year + sqrt.hdist.cont, data = mpq.1.range, family= Gamma(link=log))
plan3 <- glm(plan.range ~ year * hum_dist, data = mpq.1.range, family= Gamma(link=log))
plan4 <- glm(plan.range ~ year*sqrt.hdist.cont, data = mpq.1.range, family= Gamma(link=log))

AIC(plan1, plan2,plan3,plan4) #Top model = plan1/2
summary(plan1)
summary(plan2)
summary(plan3)
summary(plan4)


#Categorical human disturbance against region, then categorical interaction with year
plan5 <- glm(plan.range ~ year + hum_dist + island.side, data = mpq.1.range, family= Gamma(link=log))
plan6 <- glm(plan.range ~ year + hum_dist + region.3, data = mpq.1.range, family= Gamma(link=log))
plan7 <- glm(plan.range ~ year*hum_dist + island.side, data = mpq.1.range, family= Gamma(link=log))
plan8 <- glm(plan.range ~ year*hum_dist + region.3, data = mpq.1.range, family= Gamma(link=log))

AIC(plan5, plan6, plan7, plan8) #plan5/6 fit better (without interaction)


#Continuous human disturbance against region, then Continuous disturbance interaction with year
plan9 <- glm(plan.range ~ year + sqrt.hdist.cont + island.side, data = mpq.1.range, family= Gamma(link=log))
plan10 <- glm(plan.range ~ year + sqrt.hdist.cont + region.3, data = mpq.1.range, family= Gamma(link=log))
plan11 <- glm(plan.range ~ year*sqrt.hdist.cont + island.side, data = mpq.1.range, family= Gamma(link=log))
plan12 <- glm(plan.range ~ year*sqrt.hdist.cont + region.3, data = mpq.1.range, family= Gamma(link=log))

AIC(plan9, plan10, plan11, plan12) #plan9 < plan10 < plan11 <plan12

#AIC's for all thus far....
AIC(plan1, plan2,plan3,plan4, plan5, plan6, plan7, plan8,plan9, plan10, plan11, plan12)  #plan2/9 < plan1/10




#Continuous disturbance- no interaction (plan15 does not converge!)
plan13 <- glmer(plan.range ~ year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range, family= Gamma(link=log))
plan14 <- glmer(plan.range ~ year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range, family= Gamma(link=log))
plan15 <- glmer(plan.range ~ year + sqrt.hdist.cont + (1|site), data = mpq.1.range, family= Gamma(link=log)) 
plan16 <- glmer(plan.range ~ year + hum_dist + (1|site), data = mpq.1.range, family= Gamma(link=log))

AIC(plan13, plan14, plan15, plan16) #plan15< plan13/16 < plan14 all within 2AIC

#Results of models
summary(plan15)
summary(plan16)



#With interactions (plan17,18,19 do not converge)
plan17 <- glmer(plan.range ~ year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range, family= Gamma(link=log))
plan18 <- glmer(plan.range ~ year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range, family= Gamma(link=log))
plan19 <- glmer(plan.range ~ year * sqrt.hdist.cont + (1|site), data = mpq.1.range, family= Gamma(link=log))
plan20 <- glmer(plan.range ~ year * hum_dist + (1|site), data = mpq.1.range, family= Gamma(link=log))


AIC(plan17, plan18, plan19, plan20) #vrm19 <plan17 <plan20 < plan18

#Results of best fitting models
summary(plan17)
summary(plan18)
summary(plan19)
summary(plan20)


#Choosing top model
AIC(plan1, plan2,plan3,plan4, plan5, plan6, plan7, plan8,plan9, plan10, plan11, plan12, plan13, plan14, plan15, plan16,plan17, plan18, plan19, plan20) #Best fit models are: plan15< plan13 < plan13


nrow(mpq.1.range) #126 rows
 
```

## Log Transformed Models

**All models converge**

**Top models are: plan2 < plan9 < plan10/1 <plan5/6**

```{r plano curv log transformed modelling}
#nrow(mpq.1)# 127 = Any model with 3 variables or less = can use AIC
#colnames(mpq.1.range) #Call plano.range.t2

# Models year + disturbance
plan1 <- lm(plan.range.t2 ~ year + hum_dist, data = mpq.1.range)
plan2 <- lm(plan.range.t2 ~ year + sqrt.hdist.cont, data = mpq.1.range)
plan3 <- lm(plan.range.t2 ~ year * hum_dist, data = mpq.1.range)
plan4 <- lm(plan.range.t2 ~ year*sqrt.hdist.cont, data = mpq.1.range)

AIC(plan1, plan2,plan3,plan4) #Top model = plan2/plan1
summary(plan1)
summary(plan2)
summary(plan3)
summary(plan4)


#Categorical human disturbance against region, then categorical interaction with year
plan5 <- lm(plan.range.t2 ~ year + hum_dist + island.side, data = mpq.1.range)
plan6 <- lm(plan.range.t2 ~ year + hum_dist + region.3, data = mpq.1.range)
plan7 <- lm(plan.range.t2 ~ year*hum_dist + island.side, data = mpq.1.range)
plan8 <- lm(plan.range.t2 ~ year*hum_dist + region.3, data = mpq.1.range)

AIC(plan5, plan6, plan7, plan8) #plan5/6 fit better (without interaction)
summary(plan5)
summary(plan6) #Conflicting region ~human disturbance, so good thing these weren't selected

#Continuous human disturbance against region, then Continuous disturbance interaction with year
plan9 <- lm(plan.range.t2 ~ year + sqrt.hdist.cont + island.side, data = mpq.1.range)
plan10 <- lm(plan.range.t2 ~ year + sqrt.hdist.cont + region.3, data = mpq.1.range)
plan11 <- lm(plan.range.t2 ~ year*sqrt.hdist.cont + island.side, data = mpq.1.range)
plan12 <- lm(plan.range.t2 ~ year*sqrt.hdist.cont + region.3, data = mpq.1.range)

AIC(plan9, plan10, plan11, plan12) #plan9>plan10>plan11>plan12

summary(plan9)
summary(plan10)

#AIC's for all thus far....
AIC(plan1, plan2,plan3,plan4, plan5, plan6, plan7, plan8,plan9, plan10, plan11, plan12)  #plan9 > plan10 > plan2 >plan1 ...




#Continuous disturbance- no interaction (13,14,15 models do not converge!)
plan13 <- lmer(plan.range.t2 ~ year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range)
plan14 <- lmer(plan.range.t2 ~ year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range)
plan15 <- lmer(plan.range.t2 ~ year + sqrt.hdist.cont + (1|site), data = mpq.1.range)
plan16 <- lmer(plan.range.t2 ~ year + hum_dist + (1|site), data = mpq.1.range)

AIC(plan13, plan14, plan15, plan16) #plan16 < plan15 < plan13 < plan14

#Results of models
summary(plan15)
summary(plan16)


#With interactions (17,18,19 do not converge)
plan17 <- lmer(plan.range.t2 ~ year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1.range)
plan18 <- lmer(plan.range.t2 ~ year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1.range)
plan19 <- lmer(plan.range.t2 ~ year * sqrt.hdist.cont + (1|site), data = mpq.1.range)
plan20 <- lmer(plan.range.t2 ~ year * hum_dist + (1|site), data = mpq.1.range)


AIC(plan17, plan18, plan19, plan20) #plan20 < plan19 < plan17 <plan18

#Results of best fitting models
summary(plan17)
summary(plan18)
summary(plan19)
summary(plan20)


#Choosing top model
AIC(plan1, plan2,plan3,plan4, plan5, plan6, plan7, plan8,plan9, plan10, plan11, plan12, plan13, plan14, plan15, plan16,plan17, plan18, plan19, plan20) #Best fit models are: plan 2 < plan9 < plan10/1 <plan5/6 

#AICc(plan1, plan2,plan3,plan4, plan5, plan6, plan7, plan8,plan9, plan10, plan11, plan12, plan13, plan14, plan15, plan16,plan17, plan18, plan19, plan20) #Best fit models are: plan 2 < plan9 < plan10/1 <plan5/6 


```















# 10. JM MAGEL MODELLING STYLE

Global Model = "Ideally, your global model would consist of all variables thought to be useful to your particular research question" Burnham and Andersen (2002) 

Variance Structure = 

```{r JM modelling style, eval=FALSE, include=FALSE}
library(arm) 
library(nlme) #NEEDED TO RUN LME models
library(MuMIn)
library(knitr)
options(na.action = "na.fail")


# 1. Model Assumptions
# Fit the global model(s)
modelv <- lme(vrm ~ year * hdist.cont + island.side, random = ~1 | site, 
               data = mpq.1, method = "ML")

modelvv <- lme(vrm ~ year * hdist.cont + region.3, random = ~1 | site, 
               data = mpq.1, method = "ML")
#summary(modelv)
#summary(modelvv)


# Check goodness of fit of global model
r.squaredGLMM(modelv)
r.squaredGLMM(modelvv)


# Make residual plots for the global model
plot(modelv)
qqnorm(resid(modelv))

plot(modelvv)
qqnorm(resid(modelvv))

# Compare to global model with variance structure
#Region.3
modelvx <- lme(vrm ~ year * hdist.cont + region.3, random = ~1 | site, 
                weights = varIdent(form = ~1 | year), data = mpq.1, method = "ML")
modelvy <- lme(vrm ~ year * hdist.cont + region.3, random = ~1 | site, 
                weights = varIdent(form = ~1 | hdist.cont), data = mpq.1, method = "ML")

AIC(modelv, modelvx, modelvy) #Model v = top model

#For Island.side
modelvxx <- lme(vrm ~ year * hdist.cont + island.side, random = ~1 | site, 
                weights = varIdent(form = ~1 | year), data = mpq.1, method = "ML")
modelvyy <- lme(vrm ~ year * hdist.cont + island.side, random = ~1 | site, 
                weights = varIdent(form = ~1 | hdist.cont), data = mpq.1, method = "ML")

AIC(modelvv,modelvxx, modelvyy) #modelvyy = top model, followed closely by modelv/modelvy



dredged.models.islandside <- dredge(modelv, beta = c("none"), evaluate = TRUE,
    rank = "AIC", fixed = "island.side", "region.3")
dredged.models.islandside




####################################################################################
# 2. Model Selection
# Generate model set
model.setv <- dredge(modelvv, extra = "r.squaredGLMM")

# Create model selection table
model_tablev <- model.sel(model.setv)
options(scipen = 7)
names(model_tablev) <- c("(Int)", "Dist", "Year", "Year*Dist", "R2m", "R2c", "df",
                        "LL", "AICc", "delta", "weight")
kable(model_tablev, digits = 3)

# Model averaging
model.setv4 <- get.models(model.setv, subset = delta < 4)
avg_modelv <- model.avg(model.setv4)
summary(avg_modelv)
confint(avg_modelv, full = TRUE)


####################################################################################

# 3. Parameter Plot
library(ggplot2)
library(cowplot)

#Set Theme
theme_set(theme_bw() + theme(plot.title = element_text(hjust = 0.5)) + 
            theme(axis.text = element_text(size = 14, color = "black"),
                  axis.title.y = element_blank(),
                  axis.title.x = element_text(size = 17, margin = margin(20,0,0,0)),
                  plot.title = element_text(size = 22, margin = margin(0,0,15,0)),
                  plot.margin = margin(10,10,10,20), 
                  strip.background = element_rect(fill = "black"),
                  strip.text = element_text(colour = "white", size = 12),
                  panel.border = element_rect(color = "black", fill = NA, size = 1),
                  panel.grid.major = element_blank(), panel.grid.minor = element_blank()))


#Get data values for the plot
vrm_coef <- data.frame(summary(avg_modelv)[9])
vrm_ci <- data.frame(confint(avg_modelv, full = TRUE))
vrm_coef <- cbind(vrm_coef, vrm_ci)

names(vrm_coef)[names(vrm_coef) == "coefmat.full.Estimate"] <- "Estimate"
names(vrm_coef)[names(vrm_coef) == "X2.5.."] <- "LowerCI"
names(vrm_coef)[names(vrm_coef) == "X97.5.."] <- "UpperCI"

### Order of coefficients in data frame may change - check with FINAL data
vrm_coef <- vrm_coef[-1, ] #Delete first row (intercept)
rownames(vrm_coef)[1] <- "Human Disturbance"
rownames(vrm_coef)[2] <- "2016a"
rownames(vrm_coef)[3] <- "2016b"
rownames(vrm_coef)[4] <- "2017"
rownames(vrm_coef)[5] <- "2019"
rownames(vrm_coef)[6] <- "Dist*2016a"
rownames(vrm_coef)[7] <- "Dist*2016b"
rownames(vrm_coef)[8] <- "Dist*2017"
rownames(vrm_coef)[9] <- "Dist*2019"

vrm_coef$Variable <- rownames(vrm_coef)
vrm_coef$Variable <- as.factor(vrm_coef$Variable)

p1 <- ggplot(vrm_coef, aes(x = reorder(Variable, Estimate), y = Estimate)) + geom_hline(yintercept = 0, color = gray(1/2), lty = 2)
p1 <- p1 + geom_pointrange(aes(x = reorder(Variable, Estimate), y = Estimate, ymin = LowerCI, ymax = UpperCI), position = position_dodge(width = 1/2), shape = 21, fatten = 4, size = 1/2, fill = "black")
p1 <- p1 + coord_flip() + theme_cowplot() + xlab("")
p1


```




# Random Forest

This is to determine the significant contributing morphologies to each metric of complexity

```{r random forest, eval=FALSE, include=FALSE}
#Data
mpq.dig.1 #DEM 1cm
mpq.dig.4 #DEM 4cm
mpq.dig.8 #DEM 8cm

#Create Data Matrix of complexity metric ~ morphology percentages
#1. VRM
vrm.per.1 <- mpq.dig.1[,c(17:69)]
vrm.per.1 <- vrm.per.1[,-c(2:4)] #drop other complexity metrics



# Set prunescale 
prunescale = 0.0001

# Prune out rare OTUs by mean relative abundance set by prunescale
tax.mean <- taxa_sums(sites.scale)/nsamples(sites.scale)
sites.prune <- prune_taxa(tax.mean > prunescale*minlib, sites.scale)

sites.prune

# Make a dataframe of training data with OTUs as column and samples as rows
predictors <- t(otu_table(sites.prune))
dim(predictors)
## [1]  40 387


# Make one column for our outcome/response variable 
response <- as.factor(sample_data(sites.prune)$Station)

# Combine them into 1 data frame
rf.data <- data.frame(response, predictors)


#Random Forest Results
set.seed(2)
erie.classify <- randomForest(response~., data = rf.data, ntree = 100)
print(erie.classify)

```

# Models at different DEM's
## VRM
### 1cm
```{r vrm 1cm dem, eval=FALSE, include=FALSE}
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
vrm1 <- lm(vrm ~ year + hum_dist, data = mpq.1) #Hum_Dist = Categorical
vrm2 <- lm(vrm ~ year + sqrt.hdist.cont, data = mpq.1)
vrm3 <- lm(vrm ~ year * hum_dist, data = mpq.1)
vrm4 <- lm(vrm~year*sqrt.hdist.cont, data = mpq.1)

nrow(mpq.1)
AIC(vrm1,vrm2,vrm3,vrm4)

#Models without interaction of disturbance added with different regions
vrm5 <- lm(vrm ~ year + hum_dist + island.side, data = mpq.1) 
vrm6 <- lm(vrm~ year + hum_dist + region.3, data = mpq.1)
vrm7 <- lm(vrm ~ year*hum_dist + island.side, data = mpq.1)
vrm8 <- lm(vrm~year*hum_dist + region.3, data = mpq.1)

AIC(vrm5, vrm6, vrm7, vrm8) #VRM7/8 fit better (with interaction)

#Continuous human disturbance against region, then Continuous disturbance interaction with year
vrm9 <- lm(vrm ~ year + sqrt.hdist.cont + island.side, data = mpq.1)
vrm10  <- lm(vrm ~ year + sqrt.hdist.cont + region.3, data = mpq.1)
vrm11 <- lm(vrm ~ year*sqrt.hdist.cont + island.side, data = mpq.1)
vrm12 <- lm(vrm ~ year*sqrt.hdist.cont + region.3, data = mpq.1)

AIC(vrm9, vrm10, vrm11, vrm12) #All super close, vrm10 fits best (but all within 3AIC)


#Continuous disturbance- no interaction
vrm13 <- lmer(vrm~year + sqrt.hdist.cont + island.side + (1|site), data = mpq.1)
vrm14 <- lmer(vrm~year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.1)
vrm15 <- lmer(vrm~year + sqrt.hdist.cont + (1|site), data = mpq.1)
vrm16 <- lmer(vrm~year + hum_dist + (1|site), data = mpq.1)

AIC(vrm13, vrm14, vrm15, vrm16) #VRM15 best fit, but vrm16 is close  (1AIC)

#With interactions
vrm17 <- lmer(vrm~year *sqrt.hdist.cont + island.side + (1|site), data = mpq.1)
vrm18 <- lmer(vrm~year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.1)
vrm19 <- lmer(vrm~year * sqrt.hdist.cont + (1|site), data = mpq.1)
vrm20 <- lmer(vrm~year * hum_dist + (1|site), data = mpq.1)

AIC(vrm17, vrm18, vrm19, vrm20) #vrm19 best fit

#Choosing top model
AIC(vrm1, vrm2, vrm3, vrm4, vrm5, vrm6,vrm7, vrm8, vrm9, vrm10,vrm11, vrm12, vrm13, vrm14, vrm15, vrm16,vrm17, vrm18, vrm19, vrm20 ) #Best fit models are: vrm9<8<1


summary(vrm9)
summary(vrm8)
summary(vrm1)


```

### 4cm

### 8cm
```{r vrm 8cm dem, eval=FALSE, include=FALSE}
mpq.1
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
vrm1 <- lm(vrm ~ year + hum_dist, data = mpq.8) #Hum_Dist = Categorical
vrm2 <- lm(vrm ~ year + sqrt.hdist.cont, data = mpq.8)
vrm3 <- lm(vrm ~ year * hum_dist, data = mpq.8)
vrm4 <- lm(vrm~year*sqrt.hdist.cont, data = mpq.8)

nrow(mpq.8)
AIC(vrm1,vrm2,vrm3,vrm4)

#Models without interaction of disturbance added with different regions
vrm5 <- lm(vrm ~ year + hum_dist + island.side, data = mpq.8) 
vrm6 <- lm(vrm~ year + hum_dist + region.3, data = mpq.8)
vrm7 <- lm(vrm ~ year*hum_dist + island.side, data = mpq.8)
vrm8 <- lm(vrm~year*hum_dist + region.3, data = mpq.8)

AIC(vrm5, vrm6, vrm7, vrm8) #VRM7/8 fit better (with interaction)

#Continuous human disturbance against region, then Continuous disturbance interaction with year
vrm9 <- lm(vrm ~ year + sqrt.hdist.cont + island.side, data = mpq.8)
vrm10  <- lm(vrm ~ year + sqrt.hdist.cont + region.3, data = mpq.8)
vrm11 <- lm(vrm ~ year*sqrt.hdist.cont + island.side, data = mpq.8)
vrm12 <- lm(vrm ~ year*sqrt.hdist.cont + region.3, data = mpq.8)

AIC(vrm9, vrm10, vrm11, vrm12) #All super close, vrm10 fits best (but all within 3AIC)


#Continuous disturbance- no interaction
vrm13 <- lmer(vrm~year + sqrt.hdist.cont + island.side + (1|site), data = mpq.8)
vrm14 <- lmer(vrm~year + sqrt.hdist.cont + region.3 + (1|site), data = mpq.8)
vrm15 <- lmer(vrm~year + sqrt.hdist.cont + (1|site), data = mpq.8)
vrm16 <- lmer(vrm~year + hum_dist + (1|site), data = mpq.8)

AIC(vrm13, vrm14, vrm15, vrm16) #VRM15 best fit, but vrm16 is close  (1AIC)

#With interactions
vrm17 <- lmer(vrm~year *sqrt.hdist.cont + island.side + (1|site), data = mpq.8)
vrm18 <- lmer(vrm~year * sqrt.hdist.cont + region.3 + (1|site), data = mpq.8)
vrm19 <- lmer(vrm~year * sqrt.hdist.cont + (1|site), data = mpq.8)
vrm20 <- lmer(vrm~year * hum_dist + (1|site), data = mpq.8)

AIC(vrm17, vrm18, vrm19, vrm20) #vrm19 best fit

#Choosing top model
AIC(vrm1, vrm2, vrm3, vrm4, vrm5, vrm6,vrm7, vrm8, vrm9, vrm10,vrm11, vrm12, vrm13, vrm14, vrm15, vrm16,vrm17, vrm18, vrm19, vrm20 ) #Best fit models are: vrm11<12<9


summary(vrm11)
summary(vrm12)
summary(vrm9)


```

