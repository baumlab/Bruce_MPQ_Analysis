---
title: "1.5.Linear.Models.Complexity.Metrics"
author: "Kevin Bruce"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
---
 
#Load Packages/Data
```{r Load the packages and load MPQ data, include=FALSE}
rm(list = ls()) #This clears the environment
dev.off()

library(dplyr)
library(ggplot2)
library(stats)
library(Rmisc)
library(here)
library(ggpmisc)
library(knitr)
library(magick)
library(gridExtra)
library(car)
library(tidyr)
library(readxl)
library(vegan)
library(tidyverse)
library(ade4)
library(MASS)
library(ellipse)
library(FactoMineR)
library(arm)
library(ape)
library(ggrepel)
library(FactoMineR)
library(ggpubr)
library(corrplot)
library(Matrix)
library(lme4)
library(TMB)
library(glmmTMB)
library(bbmle)

#----------------------------------------------------------------------------------------------------------------------------------------------------------
#Set the Working Directory
setwd("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data")

### 1. Habitat Volume Data
cc <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_CloudCompare_Data_Clean_Updated.csv",header=TRUE, row.names=1)

#Fix ordering of levels of Habitat Volume Data




#----------------------------------------------------------------------------------------------------------------------------------------------------------
### 2. Fractal Dimension Data
frac <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Fractal_Dimension_Data_Clean.csv")




    
#----------------------------------------------------------------------------------------------------------------------------------------------------------
# 3. Complexity Data
mpq <- read.csv("~/Desktop/GitHub/Bruce_MPQ_Analysis/Data/BaumLab_Complexity_ALL_Data_Clean_updated.csv", header=TRUE, row.names = 1)


#Correct levels of hum_dist
levels(mpq$hum_dist)
mpq$hum_dist <- factor(mpq$hum_dist, levels = c("Very Low", "Medium", "Very High"))
levels(mpq$hum_dist)

#Levels for DEM
levels(mpq$DEM)
mpq$DEM <- factor(mpq$DEM, levels = c("1", "4", "8"))
levels(mpq$DEM)

#Change site to a factor (for the random effect modelling)
mpq$site <- as.factor(mpq$site)

#Create subsets for each DEM
mpq.1 <- subset (mpq, DEM == 1) 
mpq.4 <- subset (mpq, DEM == 4) 
mpq.8 <- subset (mpq, DEM == 8) 



```

```{r Exploratory plots Vrm, eval=FALSE, include=FALSE}
mpq #Dataset
mpq.num <- mpq[,16:21] #numeric datagrame only

#Check the distribution of the complexity metric
hist(mpq$vrm)   #Pretty normal looking honestly....
mpq$vlog<- log(mpq$vrm) *(-1)
hist(mpq$vlog)   #Pretty normal looking honestly....

levels(mpq$year)
str(mpq$year)

#Look for outliers via Cleveland dotplot
dotchart(mpq$vrm, ylab = "Order of operations", xlab = "Concenration", main= "VRM Cleveland Dotplot")
dotchart(mpq$vrm, groups = factor(mpq$year), ylab = "Year", xlab = "Concentration", main ="VRM Cleveland Dotplot", pch=mpq$year)

#pairplot
pairs(mpq.num) #AREA_3d and rug are collinear it appears, with curvature values very similar

#Boxplots 
boxplot(vrm ~ factor(year), varwidth = TRUE, data = mpq)
plot(vrm~site, data = mpq)


```

# 1. VRM {.tabset}
## A. Investigating categorical Hum_Dist vs continuous square root transformed Hum_dist

```{r fixed effect models}
#Models looking at disturbance gradient and if interaction between year&disturbance fit better
vrm1 <- lm(vrm ~ year + hum_dist, data = mpq) #Hum_Dist = Categorical
vrm2 <- lm(vrm ~ year + sqrt.hdist.cont, data = mpq)
vrm3 <- lm(vrm ~ year * hum_dist, data = mpq)
vrm4 <- lm(vrm~year*sqrt.hdist.cont, data = mpq)

AIC(vrm1, vrm2,vrm3,vrm4) #Top model = vrm1/vrm2
summary(vrm1)
summary(vrm2)

```



## B. Investigate region and human disturbance (cont and categorical)

Ultimately, this is to check and see whether different levels of wave energy/etc. found in select regions plays a role on the complexity around the atoll

1. VRM ~ year and human disturbance gradient (categorical- 3 levels)

2. VRM ~ year and island side (leeward/windward)

3. VRM ~ year and region 3 (3 options: South Shore, Leeward, Windward)

4. VRM ~ year and region 4 (4 options (I only have 3 though): Vaskess Bay, BOW, Leeward)) --> Should perform similarly to region.3 (which it did). 


*I didn't include:*

- Region.full: It sorts Site 32 as "Mid-Lagoon", which would be the only site in that category

- Region.kb: this follows the human disturbance gradient too closely, so will complicate the results



*RESULTS*

- All models using continuous human disturbance fit best, with lowest AIC = 12, 13 (delta AIC < 3 for all 11-16 models)

- So interaction between human disturbance and year doesn't fit best when looking at it like this.... Interesting since Jenn's paper had an interaction term in best fit.

```{r region with interactions with hdist}
#Categorical human disturbance against region, then categorical interaction with year
#Models without interaction of disturbance added with different regions
vrm5 <- lm(vrm ~ year + hum_dist + island.side, data = mpq) 
vrm6 <- lm(vrm ~ year + hum_dist + region.3, data = mpq)
vrm7 <- lm(vrm~ year + hum_dist + region.4, data = mpq)
vrm8 <- lm(vrm ~ year*hum_dist + island.side, data = mpq)
vrm9 <- lm(vrm ~ year*hum_dist + region.3, data = mpq)
vrm10 <- lm(vrm~year*hum_dist + region.4, data = mpq)

AIC(vrm5, vrm6, vrm7, vrm8, vrm9, vrm10) #AIC's the same based on if interaction is present or not (interaction makes it worse

#Continuous human disturbance against region, then Continuous disturbance interaction with year
vrm11 <- lm(vrm ~ year + sqrt.hdist.cont + island.side, data = mpq)
vrm12  <- lm(vrm ~ year + sqrt.hdist.cont + region.3, data = mpq)
vrm13 <- lm(vrm~year + sqrt.hdist.cont + region.4, data = mpq)
vrm14 <- lm(vrm ~ year*sqrt.hdist.cont + island.side, data = mpq)
vrm15 <- lm(vrm ~ year*sqrt.hdist.cont + region.3, data = mpq)
vrm16 <- lm(vrm~year*sqrt.hdist.cont + region.4, data = mpq)

AIC(vrm11, vrm12, vrm13, vrm14, vrm15, vrm16) #AIC's the same based on if interaction is present or 

#AIC's for all
AIC(vrm5, vrm6, vrm7, vrm8, vrm9, vrm10,vrm11, vrm12, vrm13, vrm14, vrm15, vrm16) 

#VRM 12, 13 are the best, however 14,15,16 are also wihtin Delta AIC <3

```

## C. With Random Effect (1|site)
- Adding to previous model iterations with both human disturbances, some with interactions between year&hum_dist, and various regions of "best fit" (island.side and region4 only)

```{r simple random effects}
#Continuous disturbance
#no interaction
vrm17 <- lmer(vrm~year + sqrt.hdist.cont + island.side + (1|site), data = mpq)
vrm18 <- lmer(vrm~year + sqrt.hdist.cont + region.4 + (1|site), data = mpq)
vrm19 <- lmer(vrm~year + sqrt.hdist.cont + (1|site), data = mpq)
vrm20 <- lmer(vrm~year + hum_dist + (1|site), data = mpq)

AIC(vrm17, vrm18, vrm19, vrm20) #VRM19 best fit, but vrm20 is close 

#Results of best fitting models
summary(vrm19)
summary(vrm20)
anova(vrm19, vrm20)

#With interactions
vrm21 <- lmer(vrm~year *sqrt.hdist.cont + island.side + (1|site), data = mpq)
vrm22 <- lmer(vrm~year * sqrt.hdist.cont + region.4 + (1|site), data = mpq)
vrm23 <- lmer(vrm~year * sqrt.hdist.cont + (1|site), data = mpq)
vrm24 <- lmer(vrm~year * hum_dist + (1|site), data = mpq)

AIC(vrm21, vrm22, vrm23, vrm24) #VRM23 best fit

#Results of best fitting models
summary(vrm23)
anova(vrm21, vrm23)


#Combine all together
AIC(vrm17, vrm18, vrm19, vrm20,vrm21, vrm22, vrm23, vrm24) #VRM19 best fit, but vrm20 is close 

#Best fit model = vrm19

#Results
# Interaction between year and human disturbance (which Jen did) doesn't make the models fit better
# Best fitting model has no region values within it (with continous human disturbance model slightly better than categorical one)

#Variance is supper low with the site intercept random effect ---> Perhaps means we can leave without?

AIC(vrm1, vrm2, vrm19, vrm20) #Models still fit better with site as a random effect

#End Result: vrm19/vrm20 models are best fit 
summary(vrm19)
summary(vrm20)
anova(vrm19, vrm20)


#Models were refit with Maximum Likelihood instead of REML
```

## D. Final findings:

- Sqrt transformed continuous disturbance fits better than categorical (for now) -->varies on how much "better" the fit is based on the model

- Interactions between either year and disturbance(continuous) or year and region all come out as worse fits than non-interaction, so probably best to drop

- Random effect has SUPER low estimates in best fit model; maybe not really that required? --> AIC between models that have same components except site RE show that including site makes the AIC a larger negative # (therefore,  --> aka better fit)


Final Working Model:

**VRM ~ year + sqrt.hdist.cont + (1|site)** OR **VRM ~ year + hum_dist + (1|site) ** 

